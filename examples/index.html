<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>index</title>
		<script type="text/javascript" src="../dist/fel.js"></script>
		<script type="text/javascript">
			var Application = fel.core.Application.extend({
				__init__: function(){
					var self = this;
					$(document).on("ready", function(){
						var translations = {
							ru: {
								"main": "главная страница",
								"hello, {0}": "привет {0}"
							}
						};
						var options = {
							views: {
								translations: {
									source: translations
								}
							},
							events: {
								"application.after_start": function(app){
									console.log("app started!"); 
									self.var1 = "first value";
									setTimeout(function(){ self.var1 = "second value"; }, 1000);
									var User = fel.models.Model.define("User",{
										age: "number",
										man: "boolean"
									});
									var User2 = User.inherit("User2", {
										superman: "boolean"
									});
									//var User = app.models_manager.User;
									User.remove_all();
									User2.remove_all();
									var Message = fel.models.Model.define("Message",{
										value: "string",
										user: {model: User} //relation
									});
									Message.remove_all();
									/*var user2 = new User2({id: "boris", age: 23, superman: true});
									user2.save(function(){
										User2.all(function(u2s){
											console.log("getted user2 objects", u2s);
										});
									});*/
									var user1 = new User({id: "stas", age:24, birthday: new Date(), man: true});
									fel.core.async.waterfall([
										function(callback){
											user1.save(function(obj){
												console.log("saved", obj);
												callback(null, obj);
											});
										},
										function(obj){
											var msg1 = new Message({value: "test msg", user: "stas"});
											msg1.save(function(m){
												console.log("saved message with user", m.user.id);
											});
											fel.core.async.parallel([
												function(callback){
													User.get(obj.id, function(obj2){
														console.log("getted", obj2, 
															_.isBoolean(obj2.man), _.isNumber(obj2.age), _.isDate(obj2.birthday));
														callback(null, obj2);
													});
												},
												function(callback){
													User.find(function(obj){ return obj.age < 24; }, function(objs){
														console.log("finded by iterator", objs, typeof objs);
													});
												}
											]);
											/*User.get(obj.id, function(obj2){
												console.log("getted", obj2, typeof obj2.man, typeof obj2.age);
											});
											User.find(function(obj){ return obj.age < 24; }, function(objs){
												console.log("finded by iterator", objs, typeof objs);
											});
											User.find({"age": 23}, function(obj){
												console.log("finded by example", obj, typeof obj);
											});
											User.exists("stas", function(is_exists){
												console.log("exists", is_exists);
											});*/
										}
									]);
									fel.core.async.waterfall([
									    function(callback){
									        setTimeout(function() {
									            console.log('f1 done');
									            callback(null, 'data from f1');
									        }, 100);
									    },
									    function(data, callback){
									        // работа с data
									        // или расширение цепочки через функцию f3, которая по окончании работы вызовет callback
									        // f3(callback);
									        console.log('f2 done');
									        callback(null, 'done');
									    }
									], function (err, result) {
									    // result now equals 'done'
									    if (err) {
									        // единое место для отлова ошибок
									    }
									    console.log(result);
									});
									setTimeout(function(){
										app.var1 = "boris";
									}, 2000);
								}
							},
							controllers:{
								initial_state: "login",
								states: {
									login: {
										enter: function(state_manager){ 
											console.log("entered to login"); 
											state_manager.event("logged_in");
										},
										logged_in: "chat" //you can define next state as string
									},
									chat: ChatController
								}
							}/*,
							models: {
								User: {
									id: "string",
									age: "number",
									man: "boolean",
									birthday: "date"
								}
							}*/
						};
						self.start(options);
						console.log("tr", fel.views.Translator().translate("hello, {0}", "Stas"));
					});
				}
			});
			window.app = new Application();
			window.ChatController = fel.controllers.Controller.extend({
				enter: function(state_manager){ 
					console.log("entered to chat");
					var v = new fel.views.View("main_page", {foo: "bar"});
					v.render("#container");
					state_manager.event("send");
				},
				send: function(){ console.log("i sent msg!"); }
			});
		</script>
		<script data-name="page" type="text/x-template">
			<div data-role="page">
				<div data-role="header" data-position="fixed" style="text-align: center;">
					{+header}{/header}
				</div>
				<div data-role="content">
					{+content}{/content}
				</div>
				<div data-role="footer" data-position="fixed">
					{+footer}{/footer}
				</div>
			</div>
		</script>
		<script data-name="main_page" type="text/x-template">
			{>page/}
			{<header}
				{@set v="main" a="55"/}
				<h3>{@trans value="main" filters="title,test"/}</h3>
				<h2>{v|trans|title}</h2>
			{/header}
			{<content}
				foo: {foo}<br/>
				morph: <div id="morph">{@binding value="app.var1"/}</div>
				morph2: <div>{@binding value="app.var1"/}</div>
				<div>morph attr</div>
			    <ul data-role="listview">
			        <li data-icon="false"><a href="#">Home</a></li>
			        <li data-icon="false"><a href="#">About </a></li>
			        <li data-icon="false"><a href="#">Portfolio </a></li>
			        <li data-icon="false"><a href="#">Contact </a></li>
			    </ul>
			{/content}
		</script>
	</head>
	<body>
		header
		<div id="container"></div>
		footer
	</body>
</html>
